<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd"
              name="entregas-dia" pageWidth="595" pageHeight="842" columnWidth="555"
              leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20">

    <!-- Qualidade de exportação -->
    <property name="net.sf.jasperreports.export.xlsx.detect.cell.type" value="true"/>
    <property name="net.sf.jasperreports.export.xlsx.one.page.per.sheet" value="false"/>
    <property name="net.sf.jasperreports.export.xlsx.white.page.background" value="false"/>

    <!-- Parâmetros -->
    <parameter name="TITULO" class="java.lang.String"/>
    <parameter name="DIA" class="java.lang.String"/>
    <parameter name="ORGANIZACAO_ID" class="java.lang.Long"/>


    <!-- Campos -->
    <field name="id" class="java.lang.Long"/>
    <field name="nomeConsumidor" class="java.lang.String"/>
    <field name="nomeProduto" class="java.lang.String"/>
    <field name="nomeEntregador" class="java.lang.String"/>
    <field name="quantidade" class="java.lang.Integer"/>
    <field name="horarioEntrega" class="java.time.LocalDateTime"/>
    <!-- Ordenação -->
    <sortField name="nomeConsumidor" order="Ascending"/>
    <sortField name="nomeProduto" order="Ascending"/>
    <!-- Variáveis de totalização -->
    <variable name="TOTAL_QTD" class="java.lang.Integer" calculation="Sum">
        <variableExpression><![CDATA[$F{quantidade}]]></variableExpression>
    </variable>
    <variable name="TOTAL_REGISTROS" class="java.lang.Integer" calculation="Count">
        <variableExpression><![CDATA[$F{id}]]></variableExpression>
    </variable>
    <variable name="SUM_QTD_CONSUMIDOR" class="java.lang.Integer" calculation="Sum" resetType="Group" resetGroup="ConsumidorGroup">
        <variableExpression><![CDATA[$F{quantidade}]]></variableExpression>
    </variable>
    <!-- Nova variável subtotal por produto -->
    <variable name="SUM_QTD_PRODUTO" class="java.lang.Integer" calculation="Sum" resetType="Group" resetGroup="ProdutoGroup">
        <variableExpression><![CDATA[$F{quantidade}]]></variableExpression>
    </variable>
    <!-- Grupo por consumidor (já existente) -->
    <group name="ConsumidorGroup">
        <groupExpression><![CDATA[$F{nomeConsumidor}]]></groupExpression>
        <groupHeader>
            <band height="14">
                <textField>
                    <reportElement x="0" y="0" width="555" height="14"/>
                    <textElement><font isBold="true"/></textElement>
                    <textFieldExpression><![CDATA["Consumidor: " + ($F{nomeConsumidor} == null ? "(Sem nome)" : $F{nomeConsumidor})]]></textFieldExpression>
                </textField>
            </band>
        </groupHeader>
        <groupFooter>
            <band height="14">
                <textField>
                    <reportElement x="240" y="0" width="315" height="14"/>
                    <textElement textAlignment="Right"><font isBold="true" size="9"/></textElement>
                    <textFieldExpression><![CDATA["Total consumidor: " + $V{SUM_QTD_CONSUMIDOR} + " (" + ($V{TOTAL_QTD} != null && $V{TOTAL_QTD} > 0 ? new java.text.DecimalFormat("0.00").format( (double)$V{SUM_QTD_CONSUMIDOR} / (double)$V{TOTAL_QTD} * 100) : "0.00") + "%)" ]]></textFieldExpression>
                </textField>
            </band>
        </groupFooter>
    </group>
    <!-- Novo grupo por produto dentro do consumidor -->
    <group name="ProdutoGroup">
        <groupExpression><![CDATA[$F{nomeProduto}]]></groupExpression>
        <groupHeader>
            <band height="12">
                <textField>
                    <reportElement x="10" y="0" width="535" height="12"/>
                    <textElement><font size="9" isBold="true"/></textElement>
                    <textFieldExpression><![CDATA["Produto: " + ($F{nomeProduto}==null?"(Sem nome)":$F{nomeProduto})]]></textFieldExpression>
                </textField>
            </band>
        </groupHeader>
        <groupFooter>
            <band height="12">
                <textField>
                    <reportElement x="300" y="0" width="245" height="12"/>
                    <textElement textAlignment="Right"><font size="8" isBold="true"/></textElement>
                    <textFieldExpression><![CDATA["Subtotal produto: " + $V{SUM_QTD_PRODUTO} + " (" + ($V{SUM_QTD_CONSUMIDOR} != null && $V{SUM_QTD_CONSUMIDOR} > 0 ? new java.text.DecimalFormat("0.00").format((double)$V{SUM_QTD_PRODUTO} / (double)$V{SUM_QTD_CONSUMIDOR} * 100) : "0.00") + "%)" ]]></textFieldExpression>
                </textField>
            </band>
        </groupFooter>
    </group>

    <!-- Título -->
    <title>
        <band height="60">
            <staticText>
                <reportElement x="0" y="0" width="555" height="30"/>
                <textElement textAlignment="Center">
                    <font size="18" isBold="true"/>
                </textElement>
                <text><![CDATA[Relatório de Entregas do Dia]]></text>
            </staticText>
            <textField>
                <reportElement x="0" y="35" width="555" height="20"/>
                <textElement textAlignment="Center">
                    <font size="10"/>
                </textElement>
                <textFieldExpression><![CDATA["Dia: " + $P{DIA}]]></textFieldExpression>
            </textField>
        </band>
    </title>

    <!-- Cabeçalho de coluna -->
    <columnHeader>
        <band height="30">
            <staticText>
                <reportElement x="0" y="0" width="40" height="30"/>
                <box><pen lineWidth="1"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle"><font isBold="true"/></textElement>
                <text><![CDATA[ID]]></text>
            </staticText>
            <staticText>
                <reportElement x="40" y="0" width="140" height="30"/>
                <box><pen lineWidth="1"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle"><font isBold="true"/></textElement>
                <text><![CDATA[Consumidor]]></text>
            </staticText>
            <staticText>
                <reportElement x="180" y="0" width="140" height="30"/>
                <box><pen lineWidth="1"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle"><font isBold="true"/></textElement>
                <text><![CDATA[Produto]]></text>
            </staticText>
            <staticText>
                <reportElement x="320" y="0" width="100" height="30"/>
                <box><pen lineWidth="1"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle"><font isBold="true"/></textElement>
                <text><![CDATA[Entregador]]></text>
            </staticText>
            <staticText>
                <reportElement x="420" y="0" width="60" height="30"/>
                <box><pen lineWidth="1"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle"><font isBold="true"/></textElement>
                <text><![CDATA[Qtd]]></text>
            </staticText>
            <staticText>
                <reportElement x="480" y="0" width="75" height="30"/>
                <box><pen lineWidth="1"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle"><font isBold="true"/></textElement>
                <text><![CDATA[Horário]]></text>
            </staticText>
        </band>
    </columnHeader>

    <!-- Detalhe -->
    <detail>
        <band height="20">
            <textField>
                <reportElement x="0" y="0" width="40" height="20"/>
                <box><pen lineWidth="1"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle"><font size="9"/></textElement>
                <textFieldExpression><![CDATA[$F{id}]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="40" y="0" width="140" height="20"/>
                <box><pen lineWidth="1"/></box>
                <textElement textAlignment="Left" verticalAlignment="Middle"><font size="9"/></textElement>
                <textFieldExpression><![CDATA[$F{nomeConsumidor}]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="180" y="0" width="140" height="20"/>
                <box><pen lineWidth="1"/></box>
                <textElement textAlignment="Left" verticalAlignment="Middle"><font size="9"/></textElement>
                <textFieldExpression><![CDATA[$F{nomeProduto}]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="320" y="0" width="100" height="20"/>
                <box><pen lineWidth="1"/></box>
                <textElement textAlignment="Left" verticalAlignment="Middle"><font size="9"/></textElement>
                <textFieldExpression><![CDATA[$F{nomeEntregador}]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="420" y="0" width="60" height="20"/>
                <box><pen lineWidth="1"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle"><font size="9"/></textElement>
                <textFieldExpression><![CDATA[$F{quantidade}]]></textFieldExpression>
            </textField>
            <!-- Data formatada via FMT -->
            <textField>
                <reportElement x="480" y="0" width="75" height="20"/>
                <textElement textAlignment="Center" verticalAlignment="Middle"><font size="9"/></textElement>
                <textFieldExpression><![CDATA[$F{horarioEntrega} != null ? java.time.format.DateTimeFormatter.ofPattern("dd/MM/yyyy HH:mm").format($F{horarioEntrega}) : "" ]]></textFieldExpression>
            </textField>
        </band>
    </detail>

    <!-- Rodapé de página -->
    <pageFooter>
        <band height="20">
            <textField>
                <reportElement x="455" y="0" width="100" height="20"/>
                <textElement textAlignment="Right"/>
                <textFieldExpression><![CDATA["Página " + $V{PAGE_NUMBER}]]></textFieldExpression>
            </textField>
        </band>
    </pageFooter>

    <!-- Summary com totalizadores -->
    <summary>
        <band height="45">
            <staticText>
                <reportElement x="0" y="5" width="200" height="15"/>
                <textElement><font isBold="true"/></textElement>
                <text><![CDATA[Total de Registros:]]></text>
            </staticText>
            <textField>
                <reportElement x="200" y="5" width="60" height="15"/>
                <textFieldExpression><![CDATA[$V{TOTAL_REGISTROS}]]></textFieldExpression>
            </textField>
            <staticText>
                <reportElement x="0" y="22" width="200" height="15"/>
                <textElement><font isBold="true"/></textElement>
                <text><![CDATA[Soma das Quantidades:]]></text>
            </staticText>
            <textField>
                <reportElement x="200" y="22" width="60" height="15"/>
                <textFieldExpression><![CDATA[$V{TOTAL_QTD}]]></textFieldExpression>
            </textField>
        </band>
    </summary>

    <!-- No data ao final -->
    <noData>
        <band height="40">
            <staticText>
                <reportElement x="0" y="10" width="555" height="20"/>
                <textElement textAlignment="Center"><font size="12" isBold="true"/></textElement>
                <text><![CDATA[Nenhum registro encontrado.]]></text>
            </staticText>
        </band>
    </noData>

</jasperReport>
