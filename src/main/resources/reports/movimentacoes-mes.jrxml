<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd"
              name="movimentacoes-mes" pageWidth="595" pageHeight="842" columnWidth="555"
              leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20">

    <!-- Props úteis (XLSX etc.) -->
    <property name="net.sf.jasperreports.export.xlsx.detect.cell.type" value="true"/>
    <property name="net.sf.jasperreports.export.xlsx.one.page.per.sheet" value="false"/>
    <property name="net.sf.jasperreports.export.xlsx.white.page.background" value="false"/>

    <!-- Parâmetros -->
    <parameter name="TITULO" class="java.lang.String"/>
    <parameter name="ANO" class="java.lang.Integer"/>
    <parameter name="MES" class="java.lang.Integer"/>
    <parameter name="ORGANIZACAO_ID" class="java.lang.Long"/>

    <!-- Campos -->
    <field name="id" class="java.lang.Long"/>
    <field name="produtoId" class="java.lang.Long"/>
    <field name="nomeProduto" class="java.lang.String"/>
    <field name="nomeConsumidor" class="java.lang.String"/>
    <field name="nomeEntregador" class="java.lang.String"/>
    <field name="quantidade" class="java.lang.Integer"/>
    <field name="dataHora" class="java.time.LocalDateTime"/>
    <field name="tipo" class="br.softsistem.Gerenciamento_de_estoque.enumeracao.TipoMovimentacao"/>

    <!-- Ordenação -->
    <sortField name="nomeConsumidor" order="Ascending"/>
    <sortField name="nomeProduto" order="Ascending"/>

    <!-- Variáveis globais -->
    <variable name="TOTAL_QTD" class="java.lang.Integer" calculation="Sum">
        <variableExpression><![CDATA[$F{quantidade}]]></variableExpression>
    </variable>
    <variable name="TOTAL_REGISTROS" class="java.lang.Integer" calculation="Count">
        <variableExpression><![CDATA[$F{id}]]></variableExpression>
    </variable>
    <variable name="TOTAL_QTD_ENTRADA" class="java.lang.Integer" calculation="Sum">
        <variableExpression><![CDATA[$F{tipo} != null && $F{tipo}.toString().equals("ENTRADA") ? $F{quantidade} : 0]]></variableExpression>
    </variable>
    <variable name="TOTAL_QTD_SAIDA" class="java.lang.Integer" calculation="Sum">
        <variableExpression><![CDATA[$F{tipo} != null && $F{tipo}.toString().equals("SAIDA") ? $F{quantidade} : 0]]></variableExpression>
    </variable>
    <variable name="SUM_QTD_CONSUMIDOR" class="java.lang.Integer" calculation="Sum" resetType="Group" resetGroup="ConsumidorGroup">
        <variableExpression><![CDATA[$F{quantidade}]]></variableExpression>
    </variable>
    <!-- Subtotal produto (reset por grupo de produto) -->
    <variable name="SUM_QTD_PRODUTO" class="java.lang.Integer" calculation="Sum" resetType="Group" resetGroup="ProdutoGroup">
        <variableExpression><![CDATA[$F{quantidade}]]></variableExpression>
    </variable>

    <!-- Grupos (devem vir antes de title/columnHeader/detail) -->
    <group name="ConsumidorGroup">
        <groupExpression><![CDATA[$F{nomeConsumidor}]]></groupExpression>
        <groupHeader>
            <band height="14">
                <textField>
                    <reportElement x="0" y="0" width="555" height="14"/>
                    <textElement><font isBold="true"/></textElement>
                    <textFieldExpression><![CDATA["Consumidor: " + ($F{nomeConsumidor}==null?"(Sem nome)":$F{nomeConsumidor})]]></textFieldExpression>
                </textField>
            </band>
        </groupHeader>
        <groupFooter>
            <band height="14">
                <textField>
                    <reportElement x="240" y="0" width="315" height="14"/>
                    <textElement textAlignment="Right"><font isBold="true" size="9"/></textElement>
                    <textFieldExpression><![CDATA["Total consumidor: " + $V{SUM_QTD_CONSUMIDOR} + " (" + ($V{TOTAL_QTD}!=null && $V{TOTAL_QTD}>0 ? new java.text.DecimalFormat("0.00").format((double)$V{SUM_QTD_CONSUMIDOR}/(double)$V{TOTAL_QTD}*100) : "0.00") + "%)" ]]></textFieldExpression>
                </textField>
            </band>
        </groupFooter>
    </group>

    <group name="ProdutoGroup">
        <groupExpression><![CDATA[$F{nomeProduto}]]></groupExpression>
        <groupHeader>
            <band height="14">
                <textField>
                    <reportElement x="10" y="0" width="535" height="14"/>
                    <textElement><font size="9" isBold="true"/></textElement>
                    <textFieldExpression><![CDATA["Produto: " + ($F{nomeProduto}==null?"(Sem nome)":$F{nomeProduto})]]></textFieldExpression>
                </textField>
            </band>
        </groupHeader>
        <groupFooter>
            <band height="14">
                <textField>
                    <reportElement x="300" y="0" width="255" height="14"/>
                    <textElement textAlignment="Right"><font size="8" isBold="true"/></textElement>
                    <textFieldExpression><![CDATA["Subtotal produto: " + $V{SUM_QTD_PRODUTO} + " (" + ($V{SUM_QTD_CONSUMIDOR}!=null && $V{SUM_QTD_CONSUMIDOR}>0 ? new java.text.DecimalFormat("0.00").format((double)$V{SUM_QTD_PRODUTO}/(double)$V{SUM_QTD_CONSUMIDOR}*100) : "0.00") + "%)" ]]></textFieldExpression>
                </textField>
            </band>
        </groupFooter>
    </group>

    <!-- title -->
    <title>
        <band height="70">
            <staticText>
                <reportElement x="0" y="0" width="555" height="30"/>
                <textElement textAlignment="Center">
                    <font size="18" isBold="true"/>
                </textElement>
                <text><![CDATA[Relatório de Movimentações do Mês]]></text>
            </staticText>
            <textField>
                <reportElement x="0" y="35" width="555" height="20"/>
                <textElement textAlignment="Center">
                    <font size="10"/>
                </textElement>
                <textFieldExpression><![CDATA["Mês/Ano: " + $P{MES} + "/" + $P{ANO}]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="0" y="55" width="555" height="15"/>
                <textElement textAlignment="Center">
                    <font size="9"/>
                </textElement>
                <textFieldExpression><![CDATA["Org ID: " + $P{ORGANIZACAO_ID}]]></textFieldExpression>
            </textField>
        </band>
    </title>

    <!-- pageHeader (opcional) -->
    <!-- <pageHeader><band height="0"/></pageHeader> -->

    <columnHeader>
        <band height="30">
            <staticText>
                <reportElement x="0" y="0" width="35" height="30"/>
                <box><pen lineWidth="1"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle"><font isBold="true"/></textElement>
                <text><![CDATA[ID]]></text>
            </staticText>
            <staticText>
                <reportElement x="35" y="0" width="145" height="30"/>
                <box leftPadding="4" rightPadding="4"><pen lineWidth="1"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle"><font isBold="true"/></textElement>
                <text><![CDATA[Produto]]></text>
            </staticText>
            <staticText>
                <reportElement x="180" y="0" width="100" height="30"/>
                <box leftPadding="4" rightPadding="4"><pen lineWidth="1"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle"><font isBold="true"/></textElement>
                <text><![CDATA[Consumidor]]></text>
            </staticText>
            <staticText>
                <reportElement x="280" y="0" width="100" height="30"/>
                <box leftPadding="4" rightPadding="4"><pen lineWidth="1"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle"><font isBold="true"/></textElement>
                <text><![CDATA[Entregador]]></text>
            </staticText>
            <staticText>
                <reportElement x="380" y="0" width="40" height="30"/>
                <box><pen lineWidth="1"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle"><font isBold="true"/></textElement>
                <text><![CDATA[Qtd]]></text>
            </staticText>
            <staticText>
                <reportElement x="420" y="0" width="95" height="30"/>
                <box><pen lineWidth="1"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle"><font isBold="true"/></textElement>
                <text><![CDATA[Data/Hora]]></text>
            </staticText>
            <staticText>
                <reportElement x="515" y="0" width="40" height="30"/>
                <box><pen lineWidth="1"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle"><font isBold="true"/></textElement>
                <text><![CDATA[Tipo]]></text>
            </staticText>
        </band>
    </columnHeader>

    <detail>
        <band height="20">
            <textField>
                <reportElement x="0" y="0" width="35" height="20"/>
                <box><pen lineWidth="1"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle"><font size="9"/></textElement>
                <textFieldExpression><![CDATA[$F{id}]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="35" y="0" width="145" height="20"/>
                <box leftPadding="4" rightPadding="4"><pen lineWidth="1"/></box>
                <textElement verticalAlignment="Middle"><font size="9"/></textElement>
                <textFieldExpression><![CDATA[$F{nomeProduto}]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="180" y="0" width="100" height="20"/>
                <box leftPadding="4" rightPadding="4"><pen lineWidth="1"/></box>
                <textElement verticalAlignment="Middle"><font size="9"/></textElement>
                <textFieldExpression><![CDATA[$F{nomeConsumidor} != null ? $F{nomeConsumidor} : "" ]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="280" y="0" width="100" height="20"/>
                <box leftPadding="4" rightPadding="4"><pen lineWidth="1"/></box>
                <textElement verticalAlignment="Middle"><font size="9"/></textElement>
                <textFieldExpression><![CDATA[$F{nomeEntregador} != null ? $F{nomeEntregador} : "" ]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="380" y="0" width="40" height="20"/>
                <box><pen lineWidth="1"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle"><font size="9"/></textElement>
                <textFieldExpression><![CDATA[$F{quantidade}]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="420" y="0" width="95" height="20"/>
                <box><pen lineWidth="1"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle"><font size="9"/></textElement>
                <textFieldExpression><![CDATA[$F{dataHora} != null ? java.time.format.DateTimeFormatter.ofPattern("dd/MM/yyyy HH:mm").format($F{dataHora}) : "" ]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="515" y="0" width="40" height="20"/>
                <box><pen lineWidth="1"/></box>
                <textElement textAlignment="Center" verticalAlignment="Middle"><font size="9"/></textElement>
                <textFieldExpression><![CDATA[$F{tipo} != null ? $F{tipo}.toString() : "" ]]></textFieldExpression>
            </textField>
        </band>
    </detail>

    <pageFooter>
        <band height="20">
            <textField>
                <reportElement x="455" y="0" width="100" height="20"/>
                <textElement textAlignment="Right"/>
                <textFieldExpression><![CDATA["Página " + $V{PAGE_NUMBER}]]></textFieldExpression>
            </textField>
        </band>
    </pageFooter>

    <summary>
        <band height="95">
            <staticText>
                <reportElement x="0" y="5" width="200" height="15"/>
                <textElement><font isBold="true"/></textElement>
                <text><![CDATA[Total de Registros:]]></text>
            </staticText>
            <textField>
                <reportElement x="200" y="5" width="60" height="15"/>
                <textFieldExpression><![CDATA[$V{TOTAL_REGISTROS}]]></textFieldExpression>
            </textField>

            <staticText>
                <reportElement x="0" y="22" width="200" height="15"/>
                <textElement><font isBold="true"/></textElement>
                <text><![CDATA[Soma Quantidades (Geral):]]></text>
            </staticText>
            <textField>
                <reportElement x="200" y="22" width="60" height="15"/>
                <textFieldExpression><![CDATA[$V{TOTAL_QTD}]]></textFieldExpression>
            </textField>

            <staticText>
                <reportElement x="0" y="39" width="200" height="15"/>
                <textElement><font isBold="true"/></textElement>
                <text><![CDATA[Qtd Entradas:]]></text>
            </staticText>
            <textField>
                <reportElement x="200" y="39" width="60" height="15"/>
                <textFieldExpression><![CDATA[$V{TOTAL_QTD_ENTRADA} + " (" + ($V{TOTAL_QTD}!=null && $V{TOTAL_QTD}>0 ? new java.text.DecimalFormat("0.00").format((double)$V{TOTAL_QTD_ENTRADA}/(double)$V{TOTAL_QTD}*100) : "0.00") + "%)" ]]></textFieldExpression>
            </textField>

            <staticText>
                <reportElement x="0" y="56" width="200" height="15"/>
                <textElement><font isBold="true"/></textElement>
                <text><![CDATA[Qtd Saídas:]]></text>
            </staticText>
            <textField>
                <reportElement x="200" y="56" width="60" height="15"/>
                <textFieldExpression><![CDATA[$V{TOTAL_QTD_SAIDA} + " (" + ($V{TOTAL_QTD}!=null && $V{TOTAL_QTD}>0 ? new java.text.DecimalFormat("0.00").format((double)$V{TOTAL_QTD_SAIDA}/(double)$V{TOTAL_QTD}*100) : "0.00") + "%)" ]]></textFieldExpression>
            </textField>

            <staticText>
                <reportElement x="0" y="73" width="200" height="15"/>
                <textElement><font isBold="true"/></textElement>
                <text><![CDATA[Saldo (Entradas - Saídas):]]></text>
            </staticText>
            <textField>
                <reportElement x="200" y="73" width="60" height="15"/>
                <textFieldExpression><![CDATA[($V{TOTAL_QTD_ENTRADA}!=null?$V{TOTAL_QTD_ENTRADA}:0) - ($V{TOTAL_QTD_SAIDA}!=null?$V{TOTAL_QTD_SAIDA}:0)]]></textFieldExpression>
            </textField>
        </band>
    </summary>

    <noData>
        <band height="40">
            <staticText>
                <reportElement x="0" y="10" width="555" height="20"/>
                <textElement textAlignment="Center"><font size="12" isBold="true"/></textElement>
                <text><![CDATA[Nenhum registro encontrado.]]></text>
            </staticText>
        </band>
    </noData>

</jasperReport>
